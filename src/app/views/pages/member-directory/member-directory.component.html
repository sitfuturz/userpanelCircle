<div class="directory-container">
  <!-- Header Section -->
  <div class="directory-header">
    <h1 class="page-title">Member Directory</h1>
    
    <!-- Search Bar -->
    <div class="search-container">
      <div class="search-box-wrapper">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="11" cy="11" r="8" stroke-width="2"/>
          <path d="M21 21l-4.35-4.35" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <input 
          type="text" 
          class="search-input"
          placeholder="Search members by name, business, keywords..."
          [value]="searchInputValue"
          (input)="onSearchChange($event)"
          [disabled]="isLoading">
        <button 
          *ngIf="searchInputValue" 
          class="clear-search-btn"
          (click)="clearSearch()"
          aria-label="Clear search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <line x1="18" y1="6" x2="6" y2="18" stroke-width="2"/>
            <line x1="6" y1="6" x2="18" y2="18" stroke-width="2"/>
          </svg>
        </button>
      </div>
      <p class="search-hint" *ngIf="searchInputValue">
        Searching for: <strong>{{ searchInputValue }}</strong>
      </p>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-container">
    <!-- City Dropdown -->
    <div class="filter-dropdown">
      <div class="custom-select" (click)="toggleCityDropdown()">
        <!-- <div class="select-trigger"> -->
          <span class="select-label">{{ selectedCity || 'Select City' }}</span>
          <svg class="dropdown-icon" [class.rotate]="showCityDropdown" width="12" height="8" viewBox="0 0 12 8" fill="none">
            <path d="M1 1.5L6 6.5L11 1.5" stroke="#666" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="select-options" [class.show]="showCityDropdown" (click)="$event.stopPropagation()">
          <!--
          <div class="search-box">
            <input 
              type="text" 
              placeholder="Search city..."
              [(ngModel)]="citySearchTerm"
              (input)="filterCities()"
              (click)="$event.stopPropagation()"
              class="search-input">
          </div>
          -->
          <div class="option-item" (click)="selectCity('')">
            <span>All Cities</span>
          </div>
          <div 
            *ngFor="let city of filteredCities" 
            class="option-item"
            [class.selected]="selectedCity === city.name"
            (click)="selectCity(city.name)">
            <span>{{ city.name }}</span>
            <span class="state-label">{{ city.state_name }}</span>
          </div>
          <div *ngIf="filteredCities.length === 0 && citySearchTerm" class="no-results">
            No cities found
          </div>
        <!-- </div> -->
      </div>
    </div>

    <!-- Chapter Dropdown -->
    <div class="filter-dropdown">
      <div class="custom-select" (click)="toggleChapterDropdown()">
        <!-- <div class="select-trigger"> -->
          <span class="select-label">
            {{ selectedChapter || 'Select Chapter' }}
            <span class="count-badge" *ngIf="filteredChapters.length > 0"></span>
          </span>
          <svg class="dropdown-icon" [class.rotate]="showChapterDropdown" width="12" height="8" viewBox="0 0 12 8" fill="none">
            <path d="M1 1.5L6 6.5L11 1.5" stroke="#666" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="select-options" [class.show]="showChapterDropdown" (click)="$event.stopPropagation()">
          <!--
          <div class="search-box">
            <input 
              type="text" 
              placeholder="Search chapter..."
              [(ngModel)]="chapterSearchTerm"
              (input)="filterChapters()"
              (click)="$event.stopPropagation()"
              class="search-input">
          </div>
          -->
          <div class="option-item" (click)="selectChapter('')">
            <span>All Chapters</span>
          </div>
          <div 
            *ngFor="let chapter of filteredChapters" 
            class="option-item"
            [class.selected]="selectedChapter === chapter.name"
            [class.disabled]="selectedCity && chapter.city_name !== selectedCity"
            (click)="selectChapter(chapter.name)">
            <span>{{ chapter.name }}</span>
            <span class="city-label">{{ chapter.city_name }}</span>
          </div>
          <div *ngIf="filteredChapters.length === 0 && chapterSearchTerm" class="no-results">
            No chapters found
          </div>
        <!-- </div> -->
      </div>
    </div>

    <!-- View Toggle -->
    <button class="view-toggle" (click)="toggleView()" [attr.aria-label]="viewMode === 'list' ? 'Switch to grid view' : 'Switch to list view'">
      <svg *ngIf="viewMode === 'list'" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <rect x="3" y="3" width="7" height="7" stroke-width="2"/>
        <rect x="14" y="3" width="7" height="7" stroke-width="2"/>
        <rect x="3" y="14" width="7" height="7" stroke-width="2"/>
        <rect x="14" y="14" width="7" height="7" stroke-width="2"/>
      </svg>
      <svg *ngIf="viewMode === 'grid'" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <line x1="3" y1="6" x2="21" y2="6" stroke-width="2"/>
        <line x1="3" y1="12" x2="21" y2="12" stroke-width="2"/>
        <line x1="3" y1="18" x2="21" y2="18" stroke-width="2"/>
      </svg>
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading members...</p>
  </div>

  <!-- Members List View -->
  <div *ngIf="!isLoading && viewMode === 'list'" class="members-list">
    <div 
      *ngFor="let member of currentMembers" 
      class="member-card"
      (click)="openUserDetailsModal(member)">
      <!-- Member Avatar -->
      <div class="member-avatar-container">
        <img 
          [src]="imageUrl+member.profilePic || 'assets/images/placeholder-avatar.png'"
          [alt]="member.name"
          class="member-avatar"
          onerror="this.src='assets/images/placeholder-image.png'">
        <!-- Badges -->
        <div *ngIf="memberBadges[member._id] && memberBadges[member._id].length > 0" class="badge-indicator">
          <span class="badge-count">{{ memberBadges[member._id].length }}</span>
        </div>
      </div>

      <!-- Member Info -->
      <div class="member-info">
        <h3 class="member-name">{{ member.name }}</h3>
        <p class="member-role">{{ member.business_name || 'Business Name Not Available' }}</p>
        <div class="member-meta">
          <span class="meta-item">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
            {{ member.city }}
          </span>
          <span class="meta-item" *ngIf="member.chapter_name">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
            </svg>
            {{ member.chapter_name }}
          </span>
        </div>
      </div>

      <!-- Member Actions -->
      <div class="member-actions">
        <button class="action-btn call-btn" (click)="callMember($event, member)" [attr.aria-label]="'Call ' + member.name">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
          </svg>
        </button>
        <button class="action-btn whatsapp-btn" (click)="whatsappMember($event, member)" [attr.aria-label]="'WhatsApp ' + member.name">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.149-.67.149-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
          </svg>
        </button>
        <button class="action-btn arrow-btn" [attr.aria-label]="'View details for ' + member.name">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="currentMembers.length === 0" class="empty-state">
      <div class="empty-icon">👥</div>
      <h3>No members found</h3>
      <p>Try adjusting your filters or search criteria</p>
    </div>
  </div>

  <!-- Members Grid View -->
  <div *ngIf="!isLoading && viewMode === 'grid'" class="members-grid">
    <div 
      *ngFor="let member of currentMembers" 
      class="member-grid-card"
      (click)="openUserDetailsModal(member)">
      <!-- Member Avatar -->
      <div class="grid-avatar-container">
        <img 
          [src]="imageUrl+member.profilePic || 'assets/images/placeholder-avatar.png'"
          [alt]="member.name"
          class="grid-avatar"
          onerror="this.src='assets/images/placeholder-image.png'">
        <!-- Badges -->
        <div *ngIf="memberBadges[member._id] && memberBadges[member._id].length > 0" class="grid-badge-indicator">
          <span class="badge-count">{{ memberBadges[member._id].length }}</span>
        </div>
      </div>

      <!-- Member Info -->
      <div class="grid-member-info">
        <h3 class="grid-member-name">{{ member.name }}</h3>
        <p class="grid-member-business">{{ member.business_name || 'Not Available' }}</p>
        <p class="grid-member-location">{{ member.city }}<span *ngIf="member.chapter_name"> • {{ member.chapter_name }}</span></p>
      </div>

      <!-- Actions -->
      <div class="grid-actions">
        <button class="grid-action-btn" (click)="callMember($event, member)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
          </svg>
        </button>
        <button class="grid-action-btn whatsapp" (click)="whatsappMember($event, member)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.149-.67.149-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div *ngIf="!isLoading && currentMembers.length > 0" class="pagination-container">
    <div class="pagination">
      <!-- Previous Button -->
      <button 
        class="pagination-btn" 
        [disabled]="currentPage <= 1"
        (click)="goToPage(currentPage - 1)">
        <span class="arrow">‹</span>
      </button>

      <!-- Page Numbers -->
      <button 
        *ngFor="let page of paginationPages"
        class="pagination-btn"
        [class.active]="page === currentPage"
        (click)="goToPage(page)">
        {{ page }}
      </button>

      <!-- Next Button -->
      <button 
        class="pagination-btn" 
        [disabled]="currentPage >= totalPages"
        (click)="goToPage(currentPage + 1)">
        <span class="arrow">›</span>
      </button>
    </div>
    
    <div class="pagination-info">
      Showing {{ (currentPage - 1) * itemsPerPage + 1 }} - {{ Math.min(currentPage * itemsPerPage, totalDocs) }} of {{ totalDocs }} members
    </div>
  </div>
</div>

<!-- User Details Modal -->
<app-user-details-modal
  [userId]="selectedUserId"
  [isOpen]="isModalOpen"
  (closeModal)="closeUserDetailsModal()">
</app-user-details-modal>